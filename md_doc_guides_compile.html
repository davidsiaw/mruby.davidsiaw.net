<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mruby: Compile</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mruby_logo_red_icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">mruby
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">mruby is the lightweight implementation of the Ruby language</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Compile </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>mruby uses Rake to compile and cross-compile all libraries and binaries.</p>
<h2>Prerequisites</h2>
<p>To compile mruby out of the source code you need the following tools:</p><ul>
<li>C Compiler (e.g. <code>gcc</code>)</li>
<li>Linker (e.g. <code>gcc</code>)</li>
<li>Archive utility (e.g. <code>ar</code>)</li>
<li>Parser generator (e.g. <code>bison</code>)</li>
<li>Ruby 2.0 or later (e.g. <code>ruby</code> or <code>jruby</code>)</li>
</ul>
<p>Optional:</p><ul>
<li>GIT (to update mruby source and integrate mrbgems easier)</li>
<li>C++ compiler (to use GEMs which include *.cpp, *.cxx, *.cc)</li>
<li>Assembler (to use GEMs which include *.asm)</li>
</ul>
<h2>Usage</h2>
<p>Inside of the root directory of the mruby source a file exists called <em>build_config.rb</em>. This file contains the build configuration of mruby and looks like this for example: </p><div class="fragment"><div class="line">MRuby::Build.new do |conf|</div><div class="line">  toolchain :gcc</div><div class="line">end</div></div><!-- fragment --><p>All tools necessary to compile mruby can be set or modified here. In case you want to maintain an additional <em>build_config.rb</em> you can define a customized path using the <em>$MRUBY_CONFIG</em> environment variable.</p>
<p>To compile just call <code>./minirake</code> inside of the mruby source root. To generate and execute the test tools call <code>./minirake test</code>. To clean all build files call <code>./minirake clean</code>. To see full command line on build, call <code>./minirake -v</code>.</p>
<h2>Build Configuration</h2>
<p>Inside of the <em>build_config.rb</em> the following options can be configured based on your environment.</p>
<h3>Toolchains</h3>
<p>The mruby build system already contains a set of toolchain templates which configure the build environment for specific compiler infrastructures.</p>
<h4>GCC</h4>
<p>Toolchain configuration for the GNU C Compiler. </p><div class="fragment"><div class="line">toolchain :gcc</div></div><!-- fragment --><h4>clang</h4>
<p>Toolchain configuration for the LLVM C Compiler clang. Mainly equal to the GCC toolchain. </p><div class="fragment"><div class="line">toolchain :clang</div></div><!-- fragment --><h4>Visual Studio 2010, 2012 and 2013</h4>
<p>Toolchain configuration for Visual Studio on Windows. If you use the <a href="http://msdn.microsoft.com/en-us/library/ms229859\(v=vs.110\).aspx">Visual Studio Command Prompt</a>, you normally do not have to specify this manually, since it gets automatically detected by our build process. </p><div class="fragment"><div class="line">toolchain :visualcpp</div></div><!-- fragment --><h4>Android</h4>
<p>Toolchain configuration for Android. </p><div class="fragment"><div class="line">toolchain :android</div></div><!-- fragment --><p>Requires the custom standalone Android NDK and the toolchain path in <code>ANDROID_STANDALONE_TOOLCHAIN</code>.</p>
<h3>Binaries</h3>
<p>It is possible to select which tools should be compiled during the compilation process. The following tools can be selected:</p><ul>
<li>mruby (mruby interpreter)</li>
<li>mirb (mruby interactive shell)</li>
</ul>
<p>To select them declare conf.gem as follows: </p><div class="fragment"><div class="line">conf.gem &quot;#{root}/mrbgems/mruby-bin-mruby&quot;</div><div class="line">conf.gem &quot;#{root}/mrbgems/mruby-bin-mirb&quot;</div></div><!-- fragment --><h3>File Separator</h3>
<p>Some environments require a different file separator character. It is possible to set the character via <code>conf.file_separator</code>. </p><div class="fragment"><div class="line">conf.file_separator = &#39;/&#39;</div></div><!-- fragment --><h3>C Compiler</h3>
<p>Configuration of the C compiler binary, flags and include paths. </p><div class="fragment"><div class="line">conf.cc do |cc|</div><div class="line">  cc.command = ...</div><div class="line">  cc.flags = ...</div><div class="line">  cc.include_paths = ...</div><div class="line">  cc.defines = ...</div><div class="line">  cc.option_include_path = ...</div><div class="line">  cc.option_define = ...</div><div class="line">  cc.compile_options = ...</div><div class="line">end</div></div><!-- fragment --><p>C Compiler has header searcher to detect installed library.</p>
<p>If you need a include path of header file use <code>search_header_path</code>: </p><div class="fragment"><div class="line"># Searches ```iconv.h```.</div><div class="line"># If found it will return include path of the header file.</div><div class="line"># Otherwise it will return nil .</div><div class="line">fail &#39;iconv.h not found&#39; unless conf.cc.search_header_path &#39;iconv.h&#39;</div></div><!-- fragment --><p>If you need a full file name of header file use <code>search_header</code>: </p><div class="fragment"><div class="line"># Searches ```iconv.h```.</div><div class="line"># If found it will return full path of the header file.</div><div class="line"># Otherwise it will return nil .</div><div class="line">iconv_h = conf.cc.search_header &#39;iconv.h&#39;</div><div class="line">print &quot;iconv.h found: #{iconv_h}\n&quot;</div></div><!-- fragment --><p>Header searcher uses compiler's <code>include_paths</code> by default. When you are using GCC toolchain (including clang toolchain since its base is gcc toolchain) it will use compiler specific include paths too. (For example <code>/usr/local/include</code>, <code>/usr/include</code>)</p>
<p>If you need a special header search paths define a singleton method <code>header_search_paths</code> to C compiler: </p><div class="fragment"><div class="line">def conf.cc.header_search_paths</div><div class="line">  [&#39;/opt/local/include&#39;] + include_paths</div><div class="line">end</div></div><!-- fragment --><h3>Linker</h3>
<p>Configuration of the Linker binary, flags and library paths. </p><div class="fragment"><div class="line">conf.linker do |linker|</div><div class="line">  linker.command = ...</div><div class="line">  linker.flags = ...</div><div class="line">  linker.flags_before_libraries = ...</div><div class="line">  linker.libraries = ...</div><div class="line">  linker.flags_after_libraries = ...</div><div class="line">  linker.library_paths = ....</div><div class="line">  linker.option_library = ...</div><div class="line">  linker.option_library_path = ...</div><div class="line">  linker.link_options = ...</div><div class="line">end</div></div><!-- fragment --><h3>Archiver</h3>
<p>Configuration of the Archiver binary and flags. </p><div class="fragment"><div class="line">conf.archiver do |archiver|</div><div class="line">  archiver.command = ...</div><div class="line">  archiver.archive_options = ...</div><div class="line">end</div></div><!-- fragment --><h3>Parser Generator</h3>
<p>Configuration of the Parser Generator binary and flags. </p><div class="fragment"><div class="line">conf.yacc do |yacc|</div><div class="line">  yacc.command = ...</div><div class="line">  yacc.compile_options = ...</div><div class="line">end</div></div><!-- fragment --><h3>GPerf</h3>
<p>Configuration of the GPerf binary and flags. </p><div class="fragment"><div class="line">conf.gperf do |gperf|</div><div class="line">  gperf.command = ...</div><div class="line">  gperf.compile_options = ...</div><div class="line">end</div></div><!-- fragment --><p>### File Extensions </p><div class="fragment"><div class="line">conf.exts do |exts|</div><div class="line">  exts.object = ...</div><div class="line">  exts.executable = ...</div><div class="line">  exts.library = ...</div><div class="line">end</div></div><!-- fragment --><h3>Mrbgems</h3>
<p>Integrate GEMs in the build process. </p><div class="fragment"><div class="line"># Integrate GEM with additional configuration</div><div class="line">conf.gem &#39;path/to/gem&#39; do |g|</div><div class="line">  g.cc.flags &lt;&lt; ...</div><div class="line">end</div><div class="line"></div><div class="line"># Integrate GEM without additional configuration</div><div class="line">conf.gem &#39;path/to/another/gem&#39;</div></div><!-- fragment --><p>See doc/mrbgems/README.md for more option about mrbgems.</p>
<h3>Mrbtest</h3>
<p>Configuration Mrbtest build process.</p>
<p>If you want mrbtest.a only, You should set <code>conf.build_mrbtest_lib_only</code> </p><div class="fragment"><div class="line">conf.build_mrbtest_lib_only</div></div><!-- fragment --><h3>Bintest</h3>
<p>Tests for mrbgem tools using CRuby. To have bintests place *.rb scripts to <code>bintest/</code> directory of mrbgems. See <code>mruby-bin-*/bintest/*.rb</code> if you need examples. If you want a temporary files use <code>tempfile</code> module of CRuby instead of <code>/tmp/</code>.</p>
<p>You can enable it with following: </p><div class="fragment"><div class="line">conf.enable_bintest</div></div><!-- fragment --><h3>C++ ABI</h3>
<p>By default, mruby uses setjmp/longjmp to implement its exceptions. But it doesn't release C++ stack object correctly. To support mrbgems written in C++, mruby can be configured to use C++ exception.</p>
<p>There are two levels of C++ exception handling. The one is <code>enable_cxx_exception</code> that enables C++ exception, but uses C ABI. The other is <code>enable_cxx_abi</code> where all files are compiled by C++ compiler.</p>
<p>When you mix C++ code, C++ exception would be enabled automatically. If you need to enable C++ exception explicitly add the following: </p><div class="fragment"><div class="line">conf.enable_cxx_exception</div></div><!-- fragment --><h4>C++ exception disabling.</h4>
<p>If your compiler does not support C++ and you want to ensure you don't use mrbgem written in C++, you can explicitly disable C++ exception, add following: </p><div class="fragment"><div class="line">conf.disable_cxx_exception</div></div><!-- fragment --><p> and you will get an error when you try to use C++ gem. Note that it must be called before <code>enable_cxx_exception</code> or <code>gem</code> method.</p>
<h3>Debugging mode</h3>
<p>To enable debugging mode add the following: </p><div class="fragment"><div class="line">conf.enable_debug</div></div><!-- fragment --><p>When debugging mode is enabled</p><ul>
<li>Macro <code>MRB_DEBUG</code> would be defined.<ul>
<li>Which means <code>mrb_assert()</code> macro is enabled.</li>
</ul>
</li>
<li>Debug information of irep would be generated by <code>mrbc</code>.<ul>
<li>Because <code>-g</code> flag would be added to <code>mrbc</code> runner.</li>
<li>You can have better backtrace of mruby scripts with this.</li>
</ul>
</li>
</ul>
<h2>Cross-Compilation</h2>
<p>mruby can also be cross-compiled from one platform to another. To achieve this the <em>build_config.rb</em> needs to contain an instance of <code>MRuby::CrossBuild</code>. This instance defines the compilation tools and flags for the target platform. An example could look like this: </p><div class="fragment"><div class="line">MRuby::CrossBuild.new(&#39;32bit&#39;) do |conf|</div><div class="line">  toolchain :gcc</div><div class="line"></div><div class="line">  conf.cc.flags &lt;&lt; &quot;-m32&quot;</div><div class="line">  conf.linker.flags &lt;&lt; &quot;-m32&quot;</div><div class="line">end</div></div><!-- fragment --><p>All configuration options of <code>MRuby::Build</code> can also be used in <code>MRuby::CrossBuild</code>.</p>
<h3>Mrbtest in Cross-Compilation</h3>
<p>In cross compilation, you can run <code>mrbtest</code> on emulator if you have it by changing configuration of test runner. </p><div class="fragment"><div class="line">conf.test_runner do |t|</div><div class="line">  t.command = ... # set emulator. this value must be non nil or false</div><div class="line">  t.flags = ... # set flags of emulator</div><div class="line"></div><div class="line">  def t.run(bin) # override `run` if you need to change the behavior of it</div><div class="line">    ... # `bin` is the full path of mrbtest</div><div class="line">  end</div><div class="line">end</div></div><!-- fragment --><h2>Build process</h2>
<p>During the build process the directory <em>build</em> will be created in the root directory. The structure of this directory will look like this: </p><pre class="fragment">+- build
   |
   +-  host
       |
       +- bin          &lt;- Binaries (mirb, mrbc and mruby)
       |
       +- lib          &lt;- Libraries (libmruby.a and libmruby_core.a)
       |
       +- mrblib
       |
       +- src
       |
       +- test         &lt;- mrbtest tool
       |
       +- tools
          |
          +- mirb
          |
          +- mrbc
          |
          +- mruby
</pre><p>The compilation workflow will look like this:</p><ul>
<li>compile all files under <em>src</em> (object files will be stored in <em>build/host/src</em>)</li>
<li>generate parser grammar out of <em>src/parse.y</em> (generated result will be stored in <em>build/host/src/y.tab.c</em>)</li>
<li>compile <em>build/host/src/y.tab.c</em> to <em>build/host/src/y.tab.o</em></li>
<li>create <em>build/host/lib/libmruby_core.a</em> out of all object files (C only)</li>
<li>create <code>build/host/bin/mrbc</code> by compiling <em>tools/mrbc/mrbc.c</em> and linking with <em>build/host/lib/libmruby_core.a</em></li>
<li>create <em>build/host/mrblib/mrblib.c</em> by compiling all *.rb files under <em>mrblib</em> with <code>build/host/bin/mrbc</code></li>
<li>compile <em>build/host/mrblib/mrblib.c</em> to <em>build/host/mrblib/mrblib.o</em></li>
<li>create <em>build/host/lib/libmruby.a</em> out of all object files (C and Ruby)</li>
<li>create <code>build/host/bin/mruby</code> by compiling <em>mrbgems/mruby-bin-mruby/tools/mruby/mruby.c</em> and linking with <em>build/host/lib/libmruby.a</em></li>
<li>create <code>build/host/bin/mirb</code> by compiling <em>mrbgems/mruby-bin-mirb/tools/mirb/mirb.c</em> and linking with <em>build/host/lib/libmruby.a</em></li>
</ul>
<div class="fragment"><div class="line"> _____    _____    ______    ____    ____    _____    _____    ____</div><div class="line">| CC  |-&gt;|GEN  |-&gt;|AR    |-&gt;|CC  |-&gt;|CC  |-&gt;|AR   |-&gt;|CC   |-&gt;|CC  |</div><div class="line">| *.c |  |y.tab|  |core.a|  |mrbc|  |*.rb|  |lib.a|  |mruby|  |mirb|</div><div class="line"> -----    -----    ------    ----    ----    -----    -----    ----</div></div><!-- fragment --><h3>Cross-Compilation</h3>
<p>In case of a cross-compilation to <em>i386</em> the <em>build</em> directory structure looks like this: </p><pre class="fragment">+- build
   |
   +-  host
   |   |
   |   +- bin           &lt;- Native Binaries
   |   |
   |   +- lib           &lt;- Native Libraries
   |   |
   |   +- mrblib
   |   |
   |   +- src
   |   |
   |   +- test          &lt;- Native mrbtest tool
   |   |
   |   +- tools
   |      |
   |      +- mirb
   |      |
   |      +- mrbc
   |      |
   |      +- mruby
   +- i386
      |
      +- bin            &lt;- Cross-compiled Binaries
      |
      +- lib            &lt;- Cross-compiled Libraries
      |
      +- mrblib
      |
      +- src
      |
      +- test           &lt;- Cross-compiled mrbtest tool
      |
      +- tools
         |
         +- mirb
         |
         +- mrbc
         |
         +- mruby
</pre><p>An extra directory is created for the target platform. In case you compile for <em>i386</em> a directory called <em>i386</em> is created under the build directory.</p>
<p>The cross compilation workflow starts in the same way as the normal compilation by compiling all <em>native</em> libraries and binaries. Afterwards the cross compilation process proceeds like this:</p><ul>
<li>cross-compile all files under <em>src</em> (object files will be stored in <em>build/i386/src</em>)</li>
<li>generate parser grammar out of <em>src/parse.y</em> (generated result will be stored in <em>build/i386/src/y.tab.c</em>)</li>
<li>cross-compile <em>build/i386/src/y.tab.c</em> to <em>build/i386/src/y.tab.o</em></li>
<li>create <em>build/i386/mrblib/mrblib.c</em> by compiling all *.rb files under <em>mrblib</em> with the native <code>build/host/bin/mrbc</code></li>
<li>cross-compile <em>build/host/mrblib/mrblib.c</em> to <em>build/host/mrblib/mrblib.o</em></li>
<li>create <em>build/i386/lib/libmruby.a</em> out of all object files (C and Ruby)</li>
<li>create <code>build/i386/bin/mruby</code> by cross-compiling <em>mrbgems/mruby-bin-mruby/tools/mruby/mruby.c</em> and linking with <em>build/i386/lib/libmruby.a</em></li>
<li>create <code>build/i386/bin/mirb</code> by cross-compiling <em>mrbgems/mruby-bin-mirb/tools/mirb/mirb.c</em> and linking with <em>build/i386/lib/libmruby.a</em></li>
<li>create <em>build/i386/lib/libmruby_core.a</em> out of all object files (C only)</li>
<li>create <code>build/i386/bin/mrbc</code> by cross-compiling <em>tools/mrbc/mrbc.c</em> and linking with <em>build/i386/lib/libmruby_core.a</em></li>
</ul>
<div class="fragment"><div class="line"> _______________________________________________________________</div><div class="line">|              Native Compilation for Host System               |</div><div class="line">|  _____      ______      _____      ____      ____      _____  |</div><div class="line">| | CC  | -&gt; |AR    | -&gt; |GEN  | -&gt; |CC  | -&gt; |CC  | -&gt; |AR   | |</div><div class="line">| | *.c |    |core.a|    |y.tab|    |mrbc|    |*.rb|    |lib.a| |</div><div class="line">|  -----      ------      -----      ----      ----      -----  |</div><div class="line"> ---------------------------------------------------------------</div><div class="line">                                ||</div><div class="line">                               \||/</div><div class="line">                                \/</div><div class="line"> ________________________________________________________________</div><div class="line">|             Cross Compilation for Target System                |</div><div class="line">|  _____      _____      _____      ____      ______      _____  |</div><div class="line">| | CC  | -&gt; |AR   | -&gt; |CC   | -&gt; |CC  | -&gt; |AR    | -&gt; |CC   | |</div><div class="line">| | *.c |    |lib.a|    |mruby|    |mirb|    |core.a|    |mrbc | |</div><div class="line">|  -----      -----      -----      ----      ------      -----  |</div><div class="line"> ----------------------------------------------------------------</div></div><!-- fragment --><h2>Build Configuration Examples</h2>
<h3>Minimal Library</h3>
<p>To build a minimal mruby library you need to use the Cross Compiling feature due to the reason that there are functions (e.g. stdio) which can't be disabled for the main build.</p>
<div class="fragment"><div class="line">MRuby::CrossBuild.new(&#39;Minimal&#39;) do |conf|</div><div class="line">  toolchain :gcc</div><div class="line"></div><div class="line">  conf.cc.defines = %w(MRB_DISABLE_STDIO)</div><div class="line">  conf.bins = []</div><div class="line">end</div></div><!-- fragment --><p>This configuration defines a cross compile build called 'Minimal' which is using the GCC and compiles for the host machine. It also disables all usages of stdio and doesn't compile any binaries (e.g. mrbc).</p>
<h2>Test Environment</h2>
<p>mruby's build process includes a test environment. In case you start the testing of mruby, a native binary called <code>mrbtest</code> will be generated and executed. This binary contains all test cases which are defined under <em>test/t</em>. In case of a cross-compilation an additional cross-compiled <em>mrbtest</em> binary is generated. You can copy this binary and run on your target system. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
