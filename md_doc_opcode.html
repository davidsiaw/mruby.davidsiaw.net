<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mruby: The new bytecode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="mruby_logo_red_icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">mruby
   &#160;<span id="projectnumber">2.0.1</span>
   </div>
   <div id="projectbrief">mruby is the lightweight implementation of the Ruby language</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The new bytecode </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We will reimplement VM to use 8bit instruction code. By bytecode, we mean real byte code. The whole purpose is reducing the memory consumption of mruby VM.</p>
<h1>Instructions</h1>
<p>Instructions are bytes. There can be 256 instructions. Currently we have 94 instructions. Instructions can take 0 to 3 operands.</p>
<h2>operands</h2>
<p>The size of operands can be either 8bits, 16bits or 24bits. In the table.1 below, the second field describes the size (and sign) of operands.</p>
<ul>
<li>B: 8bit</li>
<li>sB: signed 8bit</li>
<li>S: 16bit</li>
<li>sS: signed 16bit</li>
<li>W: 24bit</li>
</ul>
<p>First two byte operands may be extended to 16bit. When those byte operands are bigger than 256, the instruction will be prefixed by <code>OP_EXT1</code> (means 1st operand is 16bit) or <code>OP_EXT2</code> (means 2nd operand is 16bit) or <code>OP_EXT3</code> (means 1st and 2nd operands are 16bit).</p>
<p>For instructions marked by <code>'</code>, <code>OP_EXT1</code> can be prefixed. For those with <code>"</code>, either <code>OP_EXT1</code> or <code>OP_EXT2</code> or <code>OP_EXT2</code> can be prefixed.</p>
<h2>table.1 Instruction Table</h2>
<div class="fragment"><div class="line">|Instruction Name |Operand type |Semantics        </div><div class="line">|-----------------|-------------|-----------------</div><div class="line">|OP_NOP           | -           |                 </div><div class="line">|OP_MOVE&quot;         |BB           |R(a) = R(b)      </div><div class="line">|OP_LOADL&quot;        |BB           |R(a) = Pool(b)   </div><div class="line">|OP_LOADI&quot;        |BsB          |R(a) = mrb_int(b)</div><div class="line">|OP_LOADI_0&#39;      |B            |R(a) = 0</div><div class="line">|OP_LOADI_1&#39;      |B            |R(a) = 1</div><div class="line">|OP_LOADI_2&#39;      |B            |R(a) = 2</div><div class="line">|OP_LOADI_3&#39;      |B            |R(a) = 3</div><div class="line">|OP_LOADSYM&quot;      |BB           |R(a) = Syms(b)</div><div class="line">|OP_LOADNIL&#39;      |B            |R(a) = nil</div><div class="line">|OP_LOADSELF&#39;     |B            |R(a) = self</div><div class="line">|OP_LOADT&#39;        |B            |R(a) = true</div><div class="line">|OP_LOADF&#39;        |B            |R(a) = false</div><div class="line">|OP_GETGV&quot;        |BB           |R(a) = getglobal(Syms(b))</div><div class="line">|OP_SETGV&quot;        |BB           |setglobal(Syms(b), R(a))</div><div class="line">|OP_GETSV&quot;        |BB           |R(a) = Special[b]</div><div class="line">|OP_SETSV&quot;        |BB           |Special[b] = R(a)</div><div class="line">|OP_GETIV&quot;        |BB           |R(a) = ivget(Syms(b))</div><div class="line">|OP_SETIV&quot;        |BB           |ivset(Syms(b),R(a))</div><div class="line">|OP_GETCV&quot;        |BB           |R(a) = cvget(Syms(b))</div><div class="line">|OP_SETCV&quot;        |BB           |cvset(Syms(b),R(a))</div><div class="line">|OP_GETCONST&quot;     |BB           |R(a) = constget(Syms(b))</div><div class="line">|OP_SETCONST&quot;     |BB           |constset(Syms(b),R(a))</div><div class="line">|OP_GETMCNST&quot;     |BB           |R(a) = R(a)::Syms(b)</div><div class="line">|OP_SETMCNST&quot;     |BB           |R(a+1)::Syms(b) = R(a)</div><div class="line">|OP_GETUPVAR&#39;     |BBB          |R(a) = uvget(b,c)</div><div class="line">|OP_SETUPVAR&#39;     |BBB          |uvset(b,c,R(a))</div><div class="line">|OP_JMP           |S            |pc+=a</div><div class="line">|OP_JMPIF&#39;        |SB           |if R(b) pc+=a</div><div class="line">|OP_JMPNOT&#39;       |SB           |if !R(b) pc+=a</div><div class="line">|OP_ONERR         |sS           |rescue_push(pc+a)</div><div class="line">|OP_EXCEPT&#39;       |B            |R(a) = exc</div><div class="line">|OP_RESCUE&quot;       |BB           |R(b) = R(a).isa?(R(b))</div><div class="line">|OP_POPERR        |B            |a.times{rescue_pop()}</div><div class="line">|OP_RAISE&#39;        |B            |raise(R(a))</div><div class="line">|OP_EPUSH&#39;        |B            |ensure_push(SEQ[a])</div><div class="line">|OP_EPOP          |B            |A.times{ensure_pop().call}</div><div class="line">|OP_SENDV&quot;        |BB           |R(a) = call(R(a),Syms(b),*R(a+1))</div><div class="line">|OP_SENDVB&quot;       |BB           |R(a) = call(R(a),Syms(b),*R(a+1),&amp;R(a+2))</div><div class="line">|OP_SEND&quot;         |BBB          |R(a) = call(R(a),Syms(b),R(a+1),...,R(a+c))</div><div class="line">|OP_SENDB&quot;        |BBB          |R(a) = call(R(a),Syms(Bx),R(a+1),...,R(a+c),&amp;R(a+c+1))</div><div class="line">|OP_CALL&#39;         |B            |R(a) = self.call(frame.argc, frame.argv)</div><div class="line">|OP_SUPER&#39;        |BB           |R(a) = super(R(a+1),... ,R(a+b+1))</div><div class="line">|OP_ARGARY&#39;       |BS           |R(a) = argument array (16=5:1:5:1:4)</div><div class="line">|OP_ENTER         |W            |arg setup according to flags (23=5:5:1:5:5:1:1)</div><div class="line">|OP_KARG&quot;         |BB           |R(a) = kdict[Syms(Bx)]                          # todo</div><div class="line">|OP_KARG2&quot;        |BB           |R(a) = kdict[Syms(Bx)]; kdict.rm(Syms(b))       # todo</div><div class="line">|OP_RETURN&#39;       |B            |return R(a) (normal)</div><div class="line">|OP_RETURN_BLK&#39;   |B            |return R(a) (in-block return)</div><div class="line">|OP_BREAK&#39;        |B            |break R(a)</div><div class="line">|OP_BLKPUSH&#39;      |BS           |R(a) = block (16=5:1:5:1:4)</div><div class="line">|OP_ADD&quot;          |BB           |R(a) = R(a)+R(a+1)</div><div class="line">|OP_ADDI&quot;         |BBB          |R(a) = R(a)+mrb_int(c)</div><div class="line">|OP_SUB&quot;          |BB           |R(a) = R(a)-R(a+1)</div><div class="line">|OP_SUBI&quot;         |BB           |R(a) = R(a)-C</div><div class="line">|OP_MUL&quot;          |BB           |R(a) = R(a)*R(a+1)</div><div class="line">|OP_DIV&quot;          |BB           |R(a) = R(a)/R(a+1)</div><div class="line">|OP_EQ&quot;           |BB           |R(a) = R(a)==R(a+1)</div><div class="line">|OP_LT&quot;           |BB           |R(a) = R(a)&lt;R(a+1)</div><div class="line">|OP_LE&quot;           |BB           |R(a) = R(a)&lt;=R(a+1)</div><div class="line">|OP_GT&quot;           |BB           |R(a) = R(a)&gt;R(a+1)</div><div class="line">|OP_GE&quot;           |BB           |R(a) = R(a)&gt;=R(a+1)</div><div class="line">|OP_ARRAY&#39;        |BB           |R(a) = ary_new(R(a),R(a+1)..R(a+b))</div><div class="line">|OP_ARRAY2&quot;       |BB           |R(a) = ary_new(R(b),R(b+1)..R(b+c))</div><div class="line">|OP_ARYCAT&#39;       |B            |ary_cat(R(a),R(a+1))</div><div class="line">|OP_ARYPUSH&#39;      |B            |ary_push(R(a),R(a+1))</div><div class="line">|OP_AREF&#39;         |BB           |R(a) = R(a)[b]</div><div class="line">|OP_ASET&#39;         |BB           |R(a)[b] = R(a+1)</div><div class="line">|OP_APOST&#39;        |BB           |*R(a),R(A+1)..R(A+C) = R(a)[B..]</div><div class="line">|OP_STRING&quot;       |BB           |R(a) = str_dup(Lit(b))</div><div class="line">|OP_STRCAT&#39;       |B            |str_cat(R(a),R(a+1))</div><div class="line">|OP_HASH&#39;         |BB           |R(a) = hash_new(R(a),R(a+1)..R(a+b))</div><div class="line">|OP_HASHADD&#39;      |BB           |R(a) = hash_push(R(a),R(a+1)..R(a+b))</div><div class="line">|OP_LAMBDA&quot;       |BB           |R(a) = lambda(SEQ[b],OP_L_LAMBDA)</div><div class="line">|OP_BLOCK&quot;        |BB           |R(a) = lambda(SEQ[b],OP_L_BLOCK)</div><div class="line">|OP_METHOD&quot;       |BB           |R(a) = lambda(SEQ[b],OP_L_METHOD)</div><div class="line">|OP_RANGE_INC&#39;    |B            |R(a) = range_new(R(a),R(a+1),FALSE)</div><div class="line">|OP_RANGE_EXC&#39;    |B            |R(a) = range_new(R(a),R(a+1),TRUE)</div><div class="line">|OP_OCLASS&#39;       |B            |R(a) = ::Object</div><div class="line">|OP_CLASS&quot;        |BB           |R(a) = newclass(R(a),Syms(b),R(a+1))</div><div class="line">|OP_MODULE&quot;       |BB           |R(a) = newmodule(R(a),Syms(b))</div><div class="line">|OP_EXEC&quot;         |BB           |R(a) = blockexec(R(a),SEQ[b])</div><div class="line">|OP_DEF&quot;          |BB           |R(a).newmethod(Syms(b),R(a+1))</div><div class="line">|OP_ALIAS&#39;        |B            |alias_method(R(a),R(a+1),R(a+2))</div><div class="line">|OP_UNDEF&quot;        |BB           |undef_method(R(a),Syms(b))</div><div class="line">|OP_SCLASS&#39;       |B            |R(a) = R(a).singleton_class</div><div class="line">|OP_TCLASS&#39;       |B            |R(a) = target_class</div><div class="line">|OP_ERR&#39;          |B            |raise(RuntimeError, Lit(Bx))</div><div class="line">|OP_EXT1          |-            |make 1st operand 16bit</div><div class="line">|OP_EXT2          |-            |make 2nd operand 16bit</div><div class="line">|OP_EXT3          |-            |make 1st and 2nd operands 16bit</div><div class="line">|OP_STOP          |-            |stop VM</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
